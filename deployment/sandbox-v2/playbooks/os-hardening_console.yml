---
- hosts: "{{console}}"

  vars:
    oscap_profile: xccdf_org.ssgproject.content_profile_standard
    oscap_policy: ssg-centos7-ds

  tasks:
    - name: install openscap scanner
      package:
        name: "{{ item }}"
        state: latest
      with_items:
        - openscap-scanner
        - scap-security-guide

    - block:
        - name: run openscap
          become: true
          become_user: mosipuser
          command: oscap xccdf eval \
            --profile {{ oscap_profile }} \
            --results-arf /tmp/oscap-arf.xml \
            --report /tmp/oscap-report.html \
            --fetch-remote-resources \
            /usr/share/xml/scap/ssg/content/{{ oscap_policy }}.xml

      always:
        - name: download report
          become: true
          become_user: mosipuser
          fetch:
            src: /tmp/oscap-report.html
            dest: ../oscap-reports/{{ inventory_hostname }}.html
            flat: yes